# 路径修复测试清单

## 测试前准备

1. 重启服务
2. 确保服务正常运行

## 测试项目

### ✅ 1. 新任务创建和完成

**测试步骤**:
1. 创建一个新的视频转PPT任务（使用任意B站或YouTube URL）
2. 等待任务完成
3. 运行验证脚本：
   ```bash
   python verify_new_task_paths.py
   ```

**预期结果**:
- 所有路径字段显示为"相对路径"
- 格式为：`data/video_to_ppt_jobs/job_id/...`

---

### ✅ 2. 视频播放（单视频）

**测试步骤**:
1. 访问主页：`http://127.0.0.1:8002/`
2. 点击任意单视频任务
3. 检查视频是否正常播放

**预期结果**:
- 视频播放器正常加载
- 视频可以正常播放
- 截图列表正常显示

---

### ✅ 3. 视频播放（多视频段）

**测试步骤**:
1. 访问主页：`http://127.0.0.1:8002/`
2. 找到一个多视频段的任务（如GAMES101系列）
3. 点击进入播放页面
4. 尝试切换不同的视频段

**预期结果**:
- 视频段列表正常显示
- 每个视频段都可以正常播放
- 切换视频段时无404错误

---

### ✅ 4. PPT下载

**测试步骤**:
1. 访问管理页面：`http://127.0.0.1:8002/manage/ppt`
2. 找到一个已完成的任务
3. 点击"下载PPT"按钮

**预期结果**:
- PPT文件成功下载
- 文件名正确（使用任务标题）
- PPT可以正常打开

---

### ✅ 5. Slides JSON加载

**测试步骤**:
1. 访问API端点：`http://127.0.0.1:8002/api/video-ppt/jobs/{job_id}`
2. 检查返回的JSON中的`slides`字段

**预期结果**:
- `slides`数组正常返回
- 每个slide包含完整信息（index, filename, path等）
- 路径格式为相对路径

---

### ✅ 6. 已完成任务列表

**测试步骤**:
1. 访问主页：`http://127.0.0.1:8002/`
2. 检查任务列表是否正常显示
3. 检查缩略图是否正常加载

**预期结果**:
- 所有已完成任务正常显示
- 缩略图正常加载
- 任务信息完整（标题、时长、截图数等）

---

### ✅ 7. 任务队列处理

**测试步骤**:
1. 快速创建2-3个新任务
2. 观察任务队列处理情况
3. 检查任务是否按顺序执行

**预期结果**:
- 第一个任务立即开始执行
- 后续任务进入pending状态
- 前一个任务完成后，自动开始下一个任务
- 所有任务完成后，路径都是相对路径

---

### ✅ 8. 任务重新处理

**测试步骤**:
1. 访问管理页面：`http://127.0.0.1:8002/manage/ppt`
2. 找到一个已完成或失败的任务
3. 点击"重新处理"
4. 等待任务完成

**预期结果**:
- 任务状态重置为pending
- 任务重新执行
- 完成后路径仍为相对路径

---

## 数据库验证

运行以下SQL查询验证数据库中的路径：

```sql
-- 检查最近的任务
SELECT job_id, status, job_dir, video_path, ppt_path 
FROM video_ppt_jobs 
ORDER BY created_at DESC 
LIMIT 5;

-- 检查是否还有绝对路径
SELECT job_id, 
       CASE 
         WHEN job_dir LIKE 'D:%' OR job_dir LIKE 'C:%' THEN 'ABSOLUTE'
         WHEN job_dir LIKE 'data/%' THEN 'RELATIVE'
         ELSE 'OTHER'
       END as path_type
FROM video_ppt_jobs 
WHERE status = 'completed';
```

**预期结果**:
- 所有新任务的路径都是相对路径（`data/video_to_ppt_jobs/...`）
- 没有以`D:`或`C:`开头的绝对路径

---

## 故障排查

### 问题：视频无法播放（404错误）

**可能原因**:
1. 路径中包含Unicode转义字符
2. 相对路径未正确转换为绝对路径

**解决方法**:
1. 检查数据库中的`video_files`字段是否包含`/u`字符
2. 如果有，运行：`python convert_db_paths.py`
3. 重启服务

---

### 问题：PPT下载失败

**可能原因**:
1. `ppt_path`字段为相对路径但未正确解析

**解决方法**:
1. 检查`ppt_routes.py`是否使用了`resolve_relative_path()`
2. 检查文件是否真实存在

---

### 问题：新任务仍使用绝对路径

**可能原因**:
1. 代码未正确更新
2. 服务未重启

**解决方法**:
1. 确认`video_ppt_service.py`和`extractor.py`已更新
2. 重启服务
3. 创建新任务测试

---

## 测试完成标准

所有以下条件都满足：

- ✅ 新任务的所有路径字段都是相对路径
- ✅ 单视频和多视频段都能正常播放
- ✅ PPT可以正常下载
- ✅ Slides JSON正常加载
- ✅ 任务队列正常工作
- ✅ 任务重新处理功能正常
- ✅ 数据库中没有新的绝对路径记录

完成所有测试后，部署目录即可安全地复制到其他电脑使用。

